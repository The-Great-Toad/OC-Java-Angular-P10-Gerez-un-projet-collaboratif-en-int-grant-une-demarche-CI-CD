name: CI/CD Pipeline

on:
    push:
        branches: ['main']
    pull_request:
        branches: ['main']

jobs:
    # Job pour le back-end Java/Spring Boot
    test-backend:
        name: Build and Test Backend
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 11
              uses: actions/setup-java@v4
              with:
                  java-version: '11'
                  distribution: 'temurin'
                  cache: maven

            - name: Build and run tests with Maven
              run: cd back && mvn clean verify

            - name: Generate JaCoCo coverage report
              run: cd back && mvn jacoco:report

            - name: Upload backend reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: backend-reports
                  path: |
                      back/target/site/jacoco/
                      back/target/surefire-reports/
                      back/target/classes/

    # Job pour le front-end Angular
    test-frontend:
        name: Build and Test Frontend
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '16'
                  cache: 'npm'
                  cache-dependency-path: front/package-lock.json

            - name: Install dependencies
              run: cd front && npm ci

            - name: Run tests with coverage
              run: cd front && npm run test -- --no-watch --code-coverage --browsers=ChromeHeadless

            - name: Upload frontend reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: frontend-reports
                  path: front/coverage/

    # Job pour l'analyse de qualit√© avec SonarCloud
    # https://docs.sonarsource.com/sonarqube-server/devops-platform-integration/github-integration/adding-analysis-to-github-actions-workflow
    sonar-analysis:
        name: SonarCloud Code Quality Analysis
        runs-on: ubuntu-latest
        needs: [test-backend, test-frontend]
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

            - name: Set up JDK 17
              uses: actions/setup-java@v1
              with:
                  java-version: 17

            - name: Download backend reports
              uses: actions/download-artifact@v4
              with:
                  name: backend-reports
                  path: back/target/

            - name: Download frontend reports
              uses: actions/download-artifact@v4
              with:
                  name: frontend-reports
                  path: front/coverage/

            - name: Analyze backend with SonarCloud
              env:
                  SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}
              run: cd back && mvn -B sonar:sonar -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

            - name: Analyze frontend with SonarCloud
              uses: SonarSource/sonarcloud-github-action@master
              with:
                  projectBaseDir: front/
              env:
                  SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}

    docker-back-push:
        name: Build and Push Back Docker Image
        runs-on: ubuntu-latest
        needs: [test-backend, test-frontend, sonar-analysis]
        steps:
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push
              uses: docker/build-push-action@v6
              with:
                  context: '{{defaultContext}}:back'
                  push: true
                  tags: thegreattoad/bobapp/back:latest

    docker-front-push:
        name: Build and Push Front Docker Image
        runs-on: ubuntu-latest
        needs: [test-backend, test-frontend, sonar-analysis]
        steps:
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push
              uses: docker/build-push-action@v6
              with:
                  context: '{{defaultContext}}:front'
                  push: true
                  tags: thegreattoad/bobapp/front:latest
